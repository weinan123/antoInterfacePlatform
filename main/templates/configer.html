{% extends 'index.html' %}
{% block title %}<title> 接口配置</title> {% endblock %}
{% block content %}
<div class="col-md-9 row" id ="configer" style="margin-left: 16%;">
    <div style="border-bottom: 1px solid gainsboro;width: 100%">
        <h3 >接口配置信息</h3>
    </div>
    <div class="form-horizontal" role="form" style="margin:30px">
        <div class="form-group">
    <label class="col-sm-1 ">环境切换</label>
    <div class="col-sm-2">
       <select class="form-control" v-model="eviorment">
          <option selected>Qa</option>
          <option>Dev</option>
          <option>Stage</option>
          <option>Live</option>
    </select>
    </div>
  </div>
        <div class="form-group form-inline">
            <label for="lastname" class="col-sm-1 ">是否生成报告</label>
            <div class="col-sm-1 " style="margin-top: -7px">
                <div class="radio">
                    <label>
                        <input type="radio" name="optionsRadios1" id="optionsRadios3" v-model="reportY"  value="reportY" checked @click="isSend($event)">是
                    </label>
                </div>
            </div>
            <div class="col-sm-1 " style="margin-top: -7px">
                <div class="radio">
                    <label>
                    <input type="radio" name="optionsRadios1"  id="optionsRadios4" v-model="reportN"  value="reportN" @click="isSend($event)" >否
                    </label>
                </div>
            </div>
        </div>
        <div class="form-group form-inline">
        <label for="lastname" class="col-sm-1 ">是否发送邮件</label>
        <div class="col-sm-1 " style="margin-top: -7px">
            <div class="radio">
                <label>
                    <input type="radio" name="optionsRadios2" id="optionsRadios5" v-model="mailY" value="mailY" checked @click="isSend($event)">是
                </label>
            </div>
        </div>
        <div class="col-sm-1 " style="margin-top: -7px">
            <div class="radio">
                <label>
                    <input type="radio" name="optionsRadios2" id="optionsRadios6" v-model="mailN"  value="mailN" @click="isSend($event)">否
                </label>
            </div>
        </div>
  </div>
  <div v-if="isMail==='Y'" class="form-group form-inline">
      <label class="col-sm-1 " for="name">收件人</label>
      <button type="submit" class="btn btn-primary btn-sm" @click="addSender()">添加收件人</button>
       <template v-for="sender,index in senderList">
       <div v-if="index>0" style="margin-top: 7px;margin-left: 8.3%">
           <span  for="name">收件人{!index!}:</span>
            <input type="text"  class="form-control" @blur="checkemail(index,senderList[index])" id="name" placeholder="请输入收件人邮箱" v-model="senderList[index]">
            </div>
      </template>
          <p v-show="indexsss" :style="styles" >邮箱格式不正确,请检查</p>
  </div>
        <div class="form-group">
      <label class="col-sm-1 " for="name">定时执行</label>
      <div class="col-sm-5" >
                <ul id="myTab"  class="nav nav-tabs" style="margin-left: -16px">
			                <li v-for="projectName,index in projectList" v-bind:class="index===0?'active':''"><a @click="changeModel(projectName)" data-toggle="tab">
                        {! projectName !}</a></li>
                        </ul>
                <div class="row" style="border:1px solid gainsboro">

                       {% comment %} <ul class="list-group" style="text-align: center">
                            <li v-for="projectName,index in projectList" class="list-group-item " v-bind:class="index===0?'active':''" style="background-color: lightblue">{! projectName !}</li>
                        </ul>{% endcomment %}
                        {% comment %}<ul class="list-group" style="text-align: center">
                            <li v-for="model in modelList" class="list-group-item " style="background-color: lightblue">{! model !}</li>
                        </ul>{% endcomment %}

                    <div  class="col-md-12" style="margin-bottom: 5px">
                        <template v-for="item in modelList">
                        <label for="name" style="width: 100%">{! item.modelname !}:</label>
                        <template v-for="itemcase in item.allData">
                            <div style="width: 25%;float: left;">
                            <input  type="checkbox"   :value="itemcase.caseId" id="isTeam" :checked="itemcase.checked" @click="checkList($event)">
                            <span >{! itemcase.caseName !}</span>
                            </div>
                        </template>
                        </template>
                     <div style="float: right">
                        <input  type="checkbox" value="1" id="isTeam" :checked="selectAll" @click="choseAll($event)" >
                            <span >全选</span>
                        </div>
                    </div>
      </div>
  </div>
        </div>
        <div class="form-group">
        <label class="col-sm-1 " for="name">定时时间</label>
        <div class="col-sm-1">
       <select class="form-control" v-model="timingDay">
          <option selected>每天</option>
          <option>每周</option>
          <option>每月</option>
        </select>
        </div>
        <div class="col-sm-1">
        <select class="form-control" v-model="timingHour">
          <option selected>9:00</option>
          <option>15:00</option>
          <option>19:00</option>
        </select>
    </div>
    </div>
        <div class="form-group" style="margin-top: 75px">
        <div class="col-sm-1"></div>
        <div class="col-sm-2">
            <button type="submit" class="btn btn-success btn-block" @click="saveConfig()">保存设置</button>
        </div>
        <div class="col-sm-2">

        </div>
    </div>
    </div>

</div>
{% endblock %}
{% block vuejs1 %}
    <script type="text/javascript">
var vm = new Vue({
    delimiters: ['{!', '!}'],
    el:'#configer',
    data:{
        styles:{
            display: "none",
        },
        mailY:"mailY",
        indexsss:false,
        mailN:"",
        reportY:"reportY",
        reportN:"",
        isMail:"Y",
        isReport:"Y",
        senderList:[],
        projectList:[],
        modelList:[],
        allData:[],
        caseList:[],
        selectAll:false,
        timingDay:"每天",
        timingHour:"9:00",
        eviorment:"Qa",
        projectName:""
     },
    created(){
        vm1.$data.isActiveSi = false;
        vm1.$data.isActiveIn = false;
        vm1.$data.isActiveAl = false;
        vm1.$data.isActiveCo = true;
        vm1.$data.isActiveRs = false;
        this.addCase();
        //this.getinitData()
    },
     mounted:function() {
        this.getinitData();

    },
    methods:{
        isSend(e){
            let checked = e.target.checked;
            let value = e.target.value;
            if(value==='mailY'){
                this.isMail="Y";
                this.mailY = value;
                this.mailN = ""
            }else if(value==='mailN'){
                this.isMail="N";
                this.mailN = value;
                this.mailY = ""
            }else if(value==='reportY'){
                this.isReport = "Y";
                this.reportY = value;
                this.reportN = ""

            }else if(value==='reportN'){
                this.isReport = "N";
                this.reportN = value;
                this.reportY = ""
            }
        },
        addSender(){
            var data = "";
            this.senderList.push(data);
            console.log(this.senderList)
        },
        checkemail(index,email){
            this.indexsss=true;
            console.log(email);
            var reg = /^([a-zA-Z]|[0-9])(\w|\-)+@[a-zA-Z0-9]+\.([a-zA-Z]{2,4})$/;
            if(reg.test(email)){
                this.styles={
                   display: "none",
                }
            }else{
                this.styles={
                    color: "red",
                    display:"block",
                    "margin-left":"8.3%"
                }
            }
        },
        addCase(){
            axios.post('/getAllcase/')
                .then(resp =>{
                    console.log(resp.data);
                    this.projectList = resp.data.projectList;
                    console.log(this.projectList);
                    this.allData=resp.data.data;
                    console.log(this.allData);
                    this.changeModel(this.projectList[0])
                    }).catch(err=>{
                        console.log('请求失败:'+err.status+','+err.statusText);
                })
        },
        changeModel(initProjectName){
            this.modelList=[];
            for(var i=0;i<this.allData.length;i++){
                if(this.allData[i].projectName===initProjectName){
                    let data = {
                       modelname:this.allData[i].moduleName,
                       allData:this.allData[i].allcase,
                    };
                    this.modelList.push(data);
                }
            }
            this.getchecked()
        },
        choseAll(e){
            let checked = e.target.checked;
            this.selectAll = checked;
            if(checked){
                for(var q=0;q<this.allData.length;q++){
                allcase = this.allData[q].allcase;
                for(var a = 0;a<allcase.length;a++){
                    allcase[a].checked=true;
                    this.caseList.push(allcase[a].caseId.toString())
                    }
                }
            }else{
                this.caseList=[];
                for(var q=0;q<this.allData.length;q++){
                allcase = this.allData[q].allcase;
                for(var a = 0;a<allcase.length;a++){
                    allcase[a].checked=false;
                    }
                }
            }

        },
        checkList(e){
            let checked = e.target.checked;
            if(checked){
                this.caseList.push(e.target.value)
            }else{
                this.caseList.pop(e.target.value)
            }
            console.log(this.caseList)
        },
        saveConfig(){
            if(this.styles.display==="block"){
                alert("请检查界面信息")
            }
            else {
                let data_to_send = {
                    eviorment: this.eviorment,
                    isReport: this.isReport,
                    isMail: this.isMail,
                    selectAll: this.selectAll,
                    senderList: this.senderList,
                    runcase: this.caseList,
                    sechdel_time: this.timingDay + "&" + this.timingHour,
                };
                console.log(this, data_to_send);
                axios.post('/saveConfigData/', data_to_send)
                    .then(resp => {
                        toastr.options = {
                            closeButton: false,
                            debug: false,
                            progressBar: false,
                            positionClass: "toast-top-center",
                            onclick: null,
                            showDuration: "300",
                            hideDuration: "1000",
                            timeOut: "2000",
                            extendedTimeOut: "1000",
                            showEasing: "swing",
                            hideEasing: "linear",
                            showMethod: "fadeIn",
                            hideMethod: "fadeOut"
                        };
                        console.log(resp.data);
                        if (resp.data.code === 0) {
                            toastr.success(resp.data.msg);
                        } else {
                            toastr.error(resp.data.msg)
                        }
                    }).catch(err => {
                    console.log('请求失败:' + err.status + ',' + err.statusText);
                })
            }
        },
        getinitData(){
            axios.post('/getConfiginitData/')
                .then(resp =>{
                    console.log(resp.data);
                    this.showinitData(resp.data)

                    }).catch(err=>{
                        console.log('请求失败:'+err.status+','+err.statusText);
                })
        },
        getchecked(){
            for(var q=0;q<this.modelList.length;q++){
                alldata = this.modelList[q].allData;
                for(var a = 0;a<alldata.length;a++){
                    for (var f = 0;f<this.caseList.length;f++){
                        if (alldata[a].caseId===parseInt(this.caseList[f])){
                            alldata[a].checked=true
                        }
                    }
                }
            }

        },
        showinitData(initdatas){
            this.eviorment = initdatas.eviorment;
            let ismail = initdatas.ismail;
            let isReport=initdatas.isreport;
            this.isMail =  ismail;
            this.isReport = isReport;
            if(ismail==="Y"){
                this.mailY ="mailY"
            }else{
                this.mailN = "mailN"
            }
            if(isReport==="Y"){
                this.reportY = "reportY"
            }else{
                this.reportN = "reportN"
            }
            var sendlists = initdatas.senderlist.replace(/\s*/g,"").split(",");
            var runcase = initdatas.runcase.replace(/\s*/g,"").split(",");
            this.senderList = sendlists;
            var sechdelList = initdatas.sechdel_time.split("&");
            this.timingDay=sechdelList[0];
            this.timingHour=sechdelList[1];
            this.caseList = runcase;
            this.selectAll = eval(initdatas.selectall.toLowerCase());
        }

    }
})
</script>
{% endblock %}
